{% extends 'base.html' %}
{% block title %}Catalogues{% endblock %}
{% block page_description %}this is catalogues page, you can view/edit and add new catalogue{% endblock %}

{% block body %}
<div class="container border rounded p-3">
  {% include 'messages.html' %}
  <img src="{{url_for('static', filename='assets/images/loading_circle.gif')}}" class="loading_circle" style="display:none;" />
  <div class="container-fluid content_container">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <!-- per page limit -->        
        {% set limit = session["limit"] %}
        <div class="d-flex justify-content-center align-items-center w_max_content">
          <label class="mr-1 minw_max_content">Limit: </label>
          <select id="limit_select" name="limit" class="form-control" data-save-limit="{{url_for('main.savelimit')}}" data-limit="{{limit}}">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option id="custom_limit_option" value="">custom</option>
          </select>
          <div style="display:none;" id="custom_limit_cont">
            <div class="d-flex justify-content-center align-items-center">
              <input class="form-control mx-1 w_100px" type="number" id="custom_limit_input" value="" placeholder="custom" min="1">
              <button class="btn btn-sm btn-primary ml minw_max_content" id="set_custom_btn">Set Custom</button>
            </div>
          </div>
        </div>
        <!-- per page limit end -->
        <!-- settings menu-->
        <div id="settings_toast_cont">
          <button type="button" class="btn btn-outline-primary mb-1" id="open_settings">Settings</button>
          <div id="settings_toast" class="toast shadow" data-autohide="false" style="display:none">
             <div class="toast-header bg-dark text-white">
                <span><i class="fa fa-gear"></i> Settings</span>
             </div>
             <div class="toast-body">
                <div class="row">
                   <div class="col-sm-12 d-flex justify-content-start align-items-center">
                      <label>Display: </label>
                      <select class="form-control ml-2" id="switch_display">
                         <option value="table" selected="selected">Table</option>
                         <option value="card">Card</option>                     
                      </select>
                   </div>
                </div>
             </div>
          </div>
        </div>        
    </div>
    <!-- settings end -->    
    <div class="d-flex justify-content-end align-items-center">
      <!-- Button to Open the Modal for add new dashboard -->
      <a href="{{url_for('routes.add_catalogue')}}" type="button" class="btn btn-primary btn-sm">
        Add Catalogue
      </a>
      <button type="buttom" data-target="#importExcelCatalogues" data-toggle="modal" class="ml-1 btn btn-warning btn-sm mr-1">
        Import Catalogue From Excel
      </button>
      <button data-toggle="modal" data-target="#removeAllCatalogues" class="btn btn-danger btn-sm">Delete All Catalogues</button>
      
    </div>
    {% if catalogues is defined %}
    <!-- search component -->
    <div class="row mt-2 mb-2">
      <div class="col-sm-11 mx-auto" title="search by id, sku, price, location">
        <form id="search_form" class="row">
          <input class="form-control col-sm-3" type="text" name="search_value" id="search_value" placeholder="search by id, sku, price, location" value=""/>
          <select class="form-control col-sm-3" name="search_by" id="search_by">
            <option value="">Search BY</option>
            <option class="search_column" value="id">ID</option>
            <option class="search_column" value="sku">SKU</option>
            <option class="search_column" value="product_name">Product Name</option>
            <option class="search_column" value="price">Price</option>
            <option class="search_column" value="location">location</option>
          </select>
          <button type="button" id="cancel_search" class="btn btn-sm col-sm-1 btn-danger" style="display:none;"><i class="fa fa-close"></i></button>
          <select class="form-control col-sm-3" id="search_type">            
            <option value="all">all Pages</option>
            <option value="current">Current Page</option>
          </select>
          <button type="submit" class="btn btn-success col-sm-2">Search</button>
        </form>
      </div>
    </div>
    <!-- multiple select action -->
    <div class="p-2">
      <button id="selectAll" class="btn btn-secondary btn-sm">Select All</button>
      <button id="deleteCataloguesOpen" data-toggle="modal" data-target="#removeCatalogues" class="btn btn-danger btn-sm" type="button" style="display:none;">Delete Catagloues</button>
      <button id="multiple_listing_open" data-toggle="modal" data-target="#addMultipleListingModal" class="btn btn-primary btn-sm" type="button" style="display:none;">Add listings</button>
    </div>
    <!-- multiple select end -->

    <!-- search component end -->
    <!-- catalogues Pagination start -->
    <div id="catalogues_pag1" class="d-flex justify-content-center align-items-center mt-2"></div>
    <!-- Pagination end-->
    
    <!-- Card Display (For Mobile, small screen Devices ) -->
    <div class="row" id="card_display" style="display:none;">      
      {% for catalogue in catalogues %}
      <div class="searching_card col-4 p-3 d-flex justify-content-center align-items-center cursor-pointer text-decoration-none text-dark media_small_width_100"
      data-search-id="{{catalogue.id}}" data-search-sku="{{catalogue.sku}}" data-search-product_name="{{catalogue.product_name}}"
      data-search-price="{{catalogue.price}}"  data-search-location="{{catalogue.location}}">

        <div class="hover_shadow row container border rounded shadow p-3" id="products_container">
          <div class="col-sm-12 mb-3 text-center">
            <img src="{{url_for('static', filename='assets/images/'~catalogue.product_image)}}" alt="catalogue icon" width="150"class="mxwidth-150" />
          </div>
          <div class="col-sm-12">
            <p class="overflow_within text-center"><strong>{{catalogue.product_name}}</strong></p>
          </div>
          <div class="col-sm-12">
            <p class="overflow_within"><input type="checkbox" data-check-catalogue="{{catalogue.product_name}}" class="deleted_catalogues form-control w-75 mx-auto" name="deleted_catalogues" value="{{catalogue.id}}" /></p>
          </div>
          <div class="col-sm-12">
            <p class="overflow_within">SKU: <span>{{catalogue.sku}}</span></p>
          </div>
          <div class="col-sm-12">
            <p class="overflow_within">Price: <span>{{catalogue.price}}</span></p>
          </div>
          <div class="col-sm-12">
            <p class="overflow_within">Location: <span>{{catalogue.location}}</span></p>
          </div>
          <div class="col-sm-12 row">
            <div class="col-sm-6">
              <a href="{{url_for('routes.view_catalogue', catalogue_id=catalogue.id)}}" class="btn btn-primary btn-block">View</a>
            </div>
            <div class="col-sm-6">
              <a href="{{url_for('routes.edit_catalogue', catalogue_id=catalogue.id)}}" class="btn btn-secondary btn-block">Edit</a>
            </div>            
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <!-- Card Display End -->

    <!-- Table Display -->
    <div class="row" id="table_display">
      <!-- table display -->
      <div class="col-sm-12">         
        <table class="table table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Icon</th>
              <th>Product Name</th>
              <th>SKU</th>              
              <th>Price</th>
              <th>Location</th>
              <th>Action</th>
            </tr>
          </thead>
          
          <tbody>
            {% for catalogue in catalogues %}

            {# additional for current search get locations string #}
            {% set locations_arr = [] %}
            {% for catalogue_loc in catalogue.locations %}
            {% if locations_arr.append(catalogue_loc.warehouse_location.name) %}
            {% endif %}
            {% endfor %}
            {% set location_string = locations_arr|join(',') %}

            <tr class="searching_card"
            data-search-id="{{catalogue.id}}" data-search-sku="{{catalogue.sku}}" data-search-product_name="{{catalogue.product_name}}"
            data-search-price="{{catalogue.price}}"  data-search-location="{{location_string}}">
              <td>
                <p class="overflow_within"><input type="checkbox" data-check-catalogue="{{catalogue.product_name}}" class="deleted_catalogues form-control w-75" name="deleted_catalogues" value="{{catalogue.id}}" /></p>
              </td>
              <td>
                <p class="overflow_within"><img src="{{url_for('static', filename='assets/images/'~catalogue.product_image)}}" alt="listing icon" width="50" class="mxwidth-50" /></p>
              </td>                
              <td style="max-width: 200px;">{{ locations_string }}
                <p class="overflow_within">{{catalogue.product_name}}</p>
              </td>
              <td>
                <p class="overflow_within">{{catalogue.sku}}</p>
              </td>
              <td>
                <p class="overflow_within">{{catalogue.price}}</p>
              </td>
              <td>
                <div class="overflow_within" style="max-height:180px !important;overflow: auto;word-wrap: break-word;">
                  {% for catalogue_location in catalogue.locations %}
                  <div class="border border-secondary">
                    <h6 title="this is the location {{catalogue_location.warehouse_location.name}} and it's bins under it" class="badge shadow" style="display:block;">{{catalogue_location.warehouse_location.name}}</h6>
                    <div class="d-flex flex-row flex-wrap justify-content-between align-items-center p-2">
                      {% for catalogue_locations_bin in catalogue_location.bins %}
                        <span style="word-wrap: break-word;" title="This is Bin In Location {{catalogue_location.warehouse_location.name}}" class="badge badge-secondary">{{catalogue_locations_bin.bin.name}}</span>
                      {% endfor %}
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </td>                                          
              <td>
                <div class="col-sm-12 row">
                  <div class="col-sm-12 d-flex justify-content-around align-items-center">
                    <div>
                      <a href="{{url_for('routes.view_catalogue', catalogue_id=catalogue.id)}}" class="btn btn-primary btn-block btn-sm"><i class="fa fa-eye"></i></a>
                    </div>
                    <div>
                      <a href="{{url_for('routes.edit_catalogue', catalogue_id=catalogue.id)}}" class="btn btn-secondary btn-block btn-sm"><i class="fa fa-edit"></i></a>
                    </div>              
                  </div>                               
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>      
    </div>
    <!-- Table Display End -->

    <!-- catalogues Pagination start -->
    <div id="catalogues_pag2" class="d-flex justify-content-center align-items-center mt-2"></div>
    <!-- Pagination end-->
      
    {% else %}
    <div class="alert alert-danger">Unable to Display Catalogue right now.</div>
    {% endif %}    
  </div>
</div>
{{url_for('routes.view_catalogue', catalogue_id=1)}}
{% import 'forms.html' as forms %}
{{ forms.catalogues_forms(catalogues_excel=catalogues_excel,delete_catalogues=delete_catalogues, delete_all_catalogues=delete_all_catalogues, add_multiple_listings=add_multiple_listings) }}
{% endblock %}


{% block page_scripts %}
<script>
// noEffects = true;

/* Add Pagination component*/
const paginationBtns = {% if pagination_btns %}{{pagination_btns|tojson|safe}}{% else %}[]{% endif %};
const paginationPage = {{ request.args.get('page', 1) }};
displayPaginationComponent(paginationBtns, paginationPage, ['catalogues_pag1', 'catalogues_pag2']);
toggleSettingsToast();
// limit per page component
limitPerPageComponent();


const actionModalsArray = [
  {
    modalId: '#removeCatalogues',
    formId: '#remove_catalogues',
    actionLabesSelctor: '#items',
    formInputSelector: '#catalogues_ids',
    startActionBtn: '#deleteCataloguesOpen',
    totalElement: '#catalogues_ids_total'
  },
  {
    modalId: '#addMultipleListingModal',
    formId: '#add_multiple_listing',
    startActionBtn: '#multiple_listing_open',
    totalElement: '#selected_catalogues_total',
    displayLabels: false,
    setFormIdsInputVal: false,
    openModalCB: multipleListingOpenCB,
    closeModalCB: multipleListingCloseCB
  }
];






// incase component started he will allow return some public functions can accessed and used in other components called after incase component not started it will return undefined; not value
const selectComponent = multipleSelectComponent(checkboxSelector=".deleted_catalogues",  dataLabel="data-check-catalogue", actionModals=actionModalsArray, selectAllSelector="#selectAll");

// get the public function from selectComponent, to add it to change event for integeret select all component
let publicOnChangeCheckBoxSelectAll = null;
if (selectComponent && typeof(selectComponent.onChangeCheckBoxSelectAll) === 'function'){ 
  publicOnChangeCheckBoxSelectAll = selectComponent.onChangeCheckBoxSelectAll;
}

/* search (each type of page have callback to create the rows depend on the style and data and cbs) */
function rowBuildCB(catalogue){
  // if component select all started and return the public function add the event to checkbox
  const delete_change_event = (typeof(publicOnChangeCheckBoxSelectAll) == 'function' ? `onchange="publicOnChangeCheckBoxSelectAll(event)" ` : '');

  let rowHTML = '';
  if (catalogue && catalogue.id !== undefined && catalogue.sku !== undefined && catalogue.product_name !== undefined && catalogue.price !== undefined && catalogue.location !== undefined && catalogue.product_image_url !== undefined && catalogue.view_catalogue && catalogue.edit_catalogue && Array.isArray(catalogue.locations) ){
    rowHTML = `<tr class="searching_card search_all_card"
            data-search-id="${catalogue.id}" data-search-sku="${catalogue.sku}" data-search-product_name="${catalogue.product_name}"
            data-search-price="${catalogue.price}"  data-search-location="${catalogue.location}" style="background: gainsboro!important;" title="This Row not belong to this page it returned from search all">
              <td>
                <p class="overflow_within">
                  <input type="checkbox" data-check-catalogue="${catalogue.product_name}" class="deleted_catalogues form-control w-75"
                   name="deleted_catalogues" value="${catalogue.id}" ${delete_change_event}/>
                </p>
              </td>
              <td>
                <p class="overflow_within"><img src="${catalogue.product_image_url}" alt="listing icon" width="50" class="mxwidth-50" /></p>
              </td>                
              <td style="max-width: 200px;">
                <p class="overflow_within">${catalogue.product_name}</p>
              </td>
              <td>
                <p class="overflow_within">${catalogue.sku}</p>
              </td>
              <td>
                <p class="overflow_within">${catalogue.price}</p>
              </td>
              <td>
                <div class="overflow_within" style="max-height:180px !important;overflow: auto;word-wrap: break-word;">`;
                for (let l=0; l<catalogue.locations.length; l++){
                  const catalogue_location = catalogue.locations[l];
                  rowHTML += `
                  <div class="border border-secondary">
                    <h6 title="this is the location ${catalogue_location.location_name} and it's bins under it" class="badge shadow" style="display:block;">${catalogue_location.location_name}</h6>
                    <div class="d-flex flex-row flex-wrap justify-content-between align-items-center p-2">`;
                      if (Array.isArray(catalogue_location.bins)){
                        for (let b=0; b<catalogue_location.bins.length; b++){
                          const catalogue_locations_bin = catalogue_location.bins[b];
                          rowHTML += `
                                <span style="word-wrap: break-word;" title="This is Bin In Location ${catalogue_location.location_name}" class="badge badge-secondary">${catalogue_locations_bin}</span>
                          `;
                        }
                      }
                  rowHTML += `
                    </div>
                  </div>
                  `;
                }
                  
    rowHTML     += `
              </td>                                          
              <td>
                <div class="col-sm-12 row">
                  <div class="col-sm-12 d-flex justify-content-around align-items-center">
                    <div>
                      <a href="${catalogue.view_catalogue}" class="btn btn-primary btn-block btn-sm"><i class="fa fa-eye"></i></a>
                    </div>
                    <div>
                      <a href="${catalogue.edit_catalogue}" class="btn btn-secondary btn-block btn-sm"><i class="fa fa-edit"></i></a>
                    </div>              
                  </div>                               
                </div>
              </td>
          </tr>`;
  }
  return rowHTML;
}

searchComponent('fast', 'swing', cp=function(){return true;}, addon='', condition='*=', rowBuildCB=rowBuildCB, table='catalogue');


/* multiple Listings Callbacks */
function multipleListingOpenCB(selectedValues, selectedLabels){
  console.log("cb called", selectedValues, selectedLabels);
  const newListingContainers = $(".new_listing_containers");
  // start if all data is ready and all lengths same (newListingContainers equal to all catalogues of the page dynamic incase size of catalogues increased) so selected values must be less or equal this elements
  if (selectedValues.length == selectedLabels.length && newListingContainers.length >= selectedValues.length){
    for (let i=0; i< selectedValues.length; i++){
      const currentCatalogueId = selectedValues[i];
      const currentCatalogueName = selectedLabels[i];
      const currentNewListingCont = newListingContainers.eq(i);
      const currentSelectPlatform = currentNewListingCont.find('select.multiple_platform_selects');
      const currentCatalogueIdInput = currentNewListingCont.find('input.multiple_platform_ids');
      const currentCatalogueLabel = currentNewListingCont.find('label.listing_label');
      
      if (currentSelectPlatform.length && currentCatalogueIdInput.length && currentCatalogueLabel.length){
        currentCatalogueIdInput.eq(0).val(currentCatalogueId);
        currentCatalogueLabel.eq(0).text(currentCatalogueName);
        currentSelectPlatform.eq(0).show();
        currentNewListingCont.show();
        // add class to selected inputs to disable other not used input
        currentCatalogueIdInput.eq(0).addClass("used");
        currentSelectPlatform.eq(0).addClass("used");
        //multipleSelectV2();

      } else {
        console.log(`multipleListingOpenCB Error: container with index ${i} missing select platform or catalogue id input or label.`);
      }
    }

    // disable all other inputs not used
    $("select.multiple_platform_selects:not(.used)").attr("disabled", true);
    $("input.multiple_platform_ids:not(.used)").attr("disabled", true);

  } else {
    console.log("Invalid data multipleListingOpenCB not processed", newListingContainers.length);
  }
}

function multipleListingCloseCB(){
  $("select.multiple_platform_selects").val("");
  $("select.multiple_platform_selects").hide();
  $("input.multiple_platform_ids").val("");
  $("input.multiple_platform_ids").hide();
  $("label.listing_label").text("");
  $(".new_listing_containers").hide();

  // remove used class
  $("select.multiple_platform_selects.used").removeClass("used");
  $("input.multiple_platform_ids.used").removeClass("used");
  // remove disabled from inputs
  $("select.multiple_platform_selects").removeAttr("disabled");
  $("input.multiple_platform_ids").removeAttr("disabled");
}

/* default on modal, here, wtforms fildList will remove entry(select Element) if user in html not selected value (user can unselect default value so before submit back it if no value selected) */
if ($("#add_multiple_listing").length){
  $("#add_multiple_listing").on("submit", (event)=>{
    $("select.multiple_platform_selects.used").each( (_i, userSelectPlatform)=>{
      if ($(userSelectPlatform).val().length === 0){
        $(userSelectPlatform).val([0]);
      } else {
        // if user selected empty option with other options deslect it (note server will handle 0 value, but this send only needed data)
        const selectedValues = $(userSelectPlatform).val();
        if (selectedValues.length > 1 && selectedValues.includes("0")){
          const zeroOption = $(userSelectPlatform).find("option[value='0']");
          if (zeroOption.length > 0){
            zeroOption.eq(0).prop("selected", false);
          }
        }
      }
    });
  });
}



</script>
{% endblock page_scripts %}